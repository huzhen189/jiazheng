"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),QiniuFileInput=function(){function e(t){_classCallCheck(this,e);var n={max:3,accept:"image/jpeg,image/gif,image/png",size:204800};this.config=Object.assign(n,t),this.init()}return _createClass(e,[{key:"init",value:function(){new Vue({el:this.config.el,data:{progress:0,errMessage:"",config:this.config,imageList:[]},mounted:function(){if(null!=this.config.imageList){var e=!0,t=!1,n=void 0;try{for(var i,s=this.config.imageList[Symbol.iterator]();!(e=(i=s.next()).done);e=!0){var r=i.value;this.imageList.push({name:r})}}catch(e){t=!0,n=e}finally{try{!e&&s.return&&s.return()}finally{if(t)throw n}}}},methods:{setErrMessage:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";this.errMessage=e},upload:function(t){var n=this;if(t.target.files.length+this.imageList.length>this.config.max)this.setErrMessage("图片超出最大允许上传个数:"+this.config.max+",请删除一些图片!");else{var i="",s=!0,r=!1,a=void 0;try{for(var o,c=t.target.files[Symbol.iterator]();!(s=(o=c.next()).done);s=!0){var u=o.value;if(u.size>this.config.size)i+=u.name+"  ";else{var f=new FormData;f.append("file",u),f.append("token",this.config.token),f.append("key",e.getFileKey(u)),e.requestQiniu({url:this.config.url,data:f,error:function(e){n.setErrMessage(e.message)},success:function(e){"function"==typeof n.config.onsuccess&&n.config.onsuccess(e),n.imageList.push({name:n.config.cdnUrl+"/"+e.key})},progress:function(e){100===e&&setTimeout(function(){n.progress=0},500),n.progress=e}})}}}catch(e){r=!0,a=e}finally{try{!s&&c.return&&c.return()}finally{if(r)throw a}}""!==i&&this.setErrMessage(i+"超出最大限制"+parseInt(this.config.size/1024)+"KB,已忽略上传")}},deleteImg:function(e){"function"==typeof this.config.ondelete&&this.config.ondelete(this.imageList[e]),this.imageList.splice(e,1)}}})}}],[{key:"randomChar",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:5,t="0123456789qwertyuioplkjhgfdsazxcvbnm",n="",i=0;i<e;i++)n+=t.charAt(Math.ceil(1e8*Math.random())%t.length);return n}},{key:"requestQiniu",value:function(e){var t=new XMLHttpRequest;t.open("POST",e.url,!0),t.upload.addEventListener("progress",function(t){var n=Math.floor(t.loaded/t.total*100);"function"==typeof e.progress&&e.progress(n)}),t.onreadystatechange=function(n){if(4===t.readyState){if(200===t.status&&""!==t.responseText){var i=JSON.parse(t.responseText);"function"==typeof e.success&&e.success(i)}200!==t.status&&"function"==typeof e.error&&e.error({message:JSON.parse(t.responseText).error,status:t.status})}},t.send(e.data)}},{key:"getFileKey",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10,i=new Date;return i.getFullYear()+"/"+(i.getMonth()+1)+"/"+e.randomChar(n)+"."+t.name.split(".").splice(-1)}}]),e}();